import yfinance as yf
import pandas as pd
import numpy as np
from sklearn.preprocessing import MinMaxScaler
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense
import matplotlib.pyplot as plt

# Nháº­p mÃ£ cá»• phiáº¿u
symbol = input("ðŸ“¥ Nháº­p mÃ£ cá»• phiáº¿u (vÃ­ dá»¥ TSLA, AAPL, MSFT): ").upper()

# Táº£i dá»¯ liá»‡u tá»« Yahoo Finance
df = yf.download(symbol, start="2010-01-01", end="2023-12-31")

# Kiá»ƒm tra dá»¯ liá»‡u Ä‘Ã£ táº£i xuá»‘ng
if df.empty:
    print(f"âŒ KhÃ´ng cÃ³ dá»¯ liá»‡u cho mÃ£ cá»• phiáº¿u {symbol}. Vui lÃ²ng thá»­ láº¡i sau.")
else:
    # 1. Tiá»n xá»­ lÃ½ dá»¯ liá»‡u vÃ  táº¡o cÃ¡c chá»‰ bÃ¡o ká»¹ thuáº­t
    df['MA30'] = df['Close'].rolling(window=30).mean()  # Moving Average 30 ngÃ y
    df['RSI'] = 100 - (100 / (1 + (df['Close'].diff(1).where(df['Close'].diff(1) > 0, 0).rolling(window=14).mean() / 
                               df['Close'].diff(1).where(df['Close'].diff(1) < 0, 0).rolling(window=14).mean())))
    df = df.dropna()

    # 2. Sá»­ dá»¥ng dá»¯ liá»‡u 'Close', 'MA30' vÃ  'RSI' lÃ m tÃ­nh nÄƒng Ä‘áº§u vÃ o
    features = ['Close', 'MA30', 'RSI']
    df_features = df[features]

    # Chuáº©n hÃ³a dá»¯ liá»‡u
    scaler = MinMaxScaler(feature_range=(0, 1))
    scaled_data = scaler.fit_transform(df_features)

    # Táº¡o dá»¯ liá»‡u cho mÃ´ hÃ¬nh
    X = []
    y = []
    window_size = 60  # Sá»­ dá»¥ng cá»­a sá»• 60 ngÃ y

    for i in range(window_size, len(scaled_data)):
        X.append(scaled_data[i - window_size:i])
        y.append(scaled_data[i, 0])  # Dá»± Ä‘oÃ¡n giÃ¡ 'Close'

    X = np.array(X)
    y = np.array(y)

    # Reshape cho LSTM
    X = X.reshape((X.shape[0], X.shape[1], X.shape[2]))

    # 3. XÃ¢y dá»±ng mÃ´ hÃ¬nh LSTM
    model = Sequential()
    model.add(LSTM(units=100, return_sequences=True, input_shape=(X.shape[1], X.shape[2])))
    model.add(LSTM(units=100))
    model.add(Dense(1))
    model.compile(optimizer='adam', loss='mean_squared_error')

    # 4. Huáº¥n luyá»‡n mÃ´ hÃ¬nh
    model.fit(X, y, epochs=50, batch_size=32, verbose=1)

    # 5. Dá»± Ä‘oÃ¡n giÃ¡ ngÃ y mai
    last_60 = scaled_data[-window_size:]  # Láº¥y 60 ngÃ y cuá»‘i cÃ¹ng
    last_60 = last_60.reshape((1, window_size, X.shape[2]))
    predicted_scaled = model.predict(last_60)
    predicted_price = scaler.inverse_transform(np.hstack((predicted_scaled, np.zeros((predicted_scaled.shape[0], 2)))))[:, 0][0]

    # 6. Káº¿t quáº£
    today_price = df['Close'].iloc[-1]
    print(f"\nâœ… MÃ£: {symbol}")
    print(f"âœ… GiÃ¡ hÃ´m nay: ${today_price:.2f}")
    print(f"ðŸ”® Dá»± Ä‘oÃ¡n ngÃ y mai: ${predicted_price:.2f}")

    # 7. Váº½ Ä‘á»“ thá»‹ giÃ¡ Ä‘Ã³ng cá»­a vÃ  dá»± Ä‘oÃ¡n
    plt.plot(df['Close'], label="GiÃ¡ thá»±c táº¿")
    plt.axhline(predicted_price, color='red', linestyle='--', label="Dá»± Ä‘oÃ¡n ngÃ y mai")
    plt.title(f"Dá»± Ä‘oÃ¡n giÃ¡ cá»• phiáº¿u {symbol}")
    plt.legend()
    plt.grid(True)
    plt.show()

# ERROR:yfinance:['AAPL']: YFRateLimitError('Too Many Requests. Rate limited. Try after a while.')
# âŒ KhÃ´ng cÃ³ dá»¯ liá»‡u cho mÃ£ cá»• phiáº¿u AAPL. Vui lÃ²ng thá»­ láº¡i sau.
